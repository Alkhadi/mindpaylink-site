<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Buy me coffee â€¢ M Share</title>
  <meta name="description" content="Copy bank details and open your banking app quickly.">
  <link rel="stylesheet" href="style.css" />
  <style>
    .fields { display:grid; gap:8px; grid-template-columns: 1fr auto; }
    .field { display:grid; grid-template-columns: 1fr auto; align-items:center; gap:8px; }
    .copy-mini { border:1px solid var(--b); background:#0a1020; border-radius:10px; padding:8px 10px; cursor:pointer; }
    .copy-mini:focus-visible{ outline:2px solid var(--accent); outline-offset:2px }
    .chooser { position:fixed; inset:0; background:rgba(3,8,18,.6); display:none; place-items:center; }
    .chooser.open{ display:grid; }
    .chooser-card{ width:min(560px,96vw); background:var(--surface); border:1px solid var(--b);
      border-radius:16px; box-shadow:var(--shadow-1); padding:16px; }
    .chooser-list{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px }
    .chooser .close{ float:right; border:none; background:#0a1020; color:var(--fg); border:1px solid var(--b);
      border-radius:10px; padding:8px 10px; cursor:pointer; }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container navbar">
      <a id="brandLink" class="brand"><span class="logo">M</span> M Share</a>
      <nav class="main-nav" id="mainNav">
        <a data-href="index.html">Wellbeing</a>
        <a data-href="coffee.html" aria-current="page">Buy me coffee</a>
        <a data-href="pdf.html">PDF</a>
        <a data-href="storage.html">Storage</a>
        <button id="shareOpen" class="btn" type="button"><span class="icon">ğŸ”—</span> Share</button>
      </nav>
      <button id="navToggle" class="nav-toggle" aria-label="Menu">â˜°</button>
    </div>
  </header>

  <main class="container">
    <div class="card">
      <h1>Buy me a coffee â˜•</h1>
      <p class="muted">
        Tap <b>Copy details</b> then <b>Open bank app</b>. We try your installed app first and gracefully fall back.
      </p>

      <!-- Bank details -->
      <div class="kv-grid" style="margin-top:12px">
        <div class="kv"><div class="muted">Account name</div><div id="accName" style="font-weight:600">â€”</div></div>
        <div class="kv"><div class="muted">Bank</div><div id="bankName" style="font-weight:600">â€”</div></div>
        <div class="kv"><div class="muted">Reference</div><div id="ref" style="font-weight:600">M SHARE</div></div>
        <div class="kv"><div class="muted">Account number</div><div id="acc" style="font-weight:600">â€”</div></div>
        <div class="kv"><div class="muted">Sort code</div><div id="sort" style="font-weight:600">â€”</div></div>
        <div class="kv"><div class="muted">IBAN</div><div id="iban" style="font-weight:600">â€”</div></div>
      </div>

      <!-- Actions -->
      <div class="actions">
        <button class="btn" id="copyAll">ğŸ“‹ Copy details</button>
        <button class="btn" id="openChooser">ğŸ¦ Open bank app</button>
        <span id="feedback" class="muted"></span>
      </div>

      <!-- Per-field copy -->
      <div class="card" style="margin-top:12px">
        <h3 style="margin-top:0">Quick copy (single fields)</h3>
        <div class="fields">
          <div class="field"><div class="muted">Name</div><div id="f_name" class="val">â€”</div></div>
          <button class="copy-mini" data-k="payee_full_name">Copy</button>

          <div class="field"><div class="muted">Bank</div><div id="f_bank" class="val">â€”</div></div>
          <button class="copy-mini" data-k="bank_name">Copy</button>

          <div class="field"><div class="muted">Account</div><div id="f_acc" class="val">â€”</div></div>
          <button class="copy-mini" data-k="account_number">Copy</button>

          <div class="field"><div class="muted">Sort code</div><div id="f_sort" class="val">â€”</div></div>
          <button class="copy-mini" data-k="sort_code">Copy</button>

          <div class="field"><div class="muted">IBAN</div><div id="f_iban" class="val">â€”</div></div>
          <button class="copy-mini" data-k="iban">Copy</button>
        </div>
        <p class="muted" style="margin-top:8px">On iOS 16+, allow paste if prompted.</p>
      </div>
    </div>
  </main>

  <!-- Bank chooser modal -->
  <div id="chooser" class="chooser" role="dialog" aria-modal="true" aria-labelledby="chooserTitle">
    <div class="chooser-card">
      <button class="close" id="chooserClose" aria-label="Close">âœ•</button>
      <h3 id="chooserTitle" style="margin:0 0 6px">Choose your bank</h3>
      <div class="chooser-list" id="chooserList"></div>
      <p class="muted" style="margin-top:10px">If nothing opens, open your bank app manually and paste the copied details.</p>
    </div>
  </div>

  <!-- Share sheet (existing) -->
  <div id="shareSheet" class="sheet hidden">
    <div id="shareBackdrop" style="position:absolute; inset:0;"></div>
    <div class="sheet-card" role="dialog" aria-modal="true" aria-labelledby="shareTitle">
      <div class="sheet-head"><h2 id="shareTitle" class="sheet-title">Share</h2><button id="shareClose" class="sheet-close" aria-label="Close">Ã—</button></div>
      <textarea id="shareText" class="share-text" readonly></textarea>
      <div class="share-actions">
        <button class="btn" id="copyShare">ğŸ“‹ Copy</button>
        <button class="btn" id="shareNative">ğŸ”— Shareâ€¦</button>
      </div>
    </div>
  </div>

  <script src="app.js"></script>
  <script>
    (function () {
      const { data, bankDetailsString, openAppOrStore } = window.__MSHARE__ || { data:{} };

      // --- Resolve values (with sensible defaults) ---
      const payee = data.name || data.payee_full_name || 'Alkhadi Koroma';
      const bank  = data.bank_name || data.bank || 'Santander';
      const acc   = data.acc || data.account_number || '93087283';
      const sort  = (data.sort || data.sort_code || '09-01-35');
      const iban  = data.iban || '';
      const ref   = data.ref || data.reference || 'M SHARE';

      // Fill UI
      (id=>document.getElementById(id).textContent = payee)('accName');
      (id=>document.getElementById(id).textContent = bank)('bankName');
      (id=>document.getElementById(id).textContent = ref)('ref');
      (id=>document.getElementById(id).textContent = acc)('acc');
      (id=>document.getElementById(id).textContent = sort)('sort');
      (id=>document.getElementById(id).textContent = (iban || 'â€”'))('iban');

      document.getElementById('f_name').textContent = payee;
      document.getElementById('f_bank').textContent = bank;
      document.getElementById('f_acc').textContent  = acc;
      document.getElementById('f_sort').textContent = sort;
      document.getElementById('f_iban').textContent = iban || 'â€”';

      // Structured payload for clipboard / bridge
      const payload = {
        payee_full_name: payee,
        bank_name: bank,
        account_number: acc,
        sort_code: sort.replace(/[^0-9]/g,'').replace(/(\d{2})(\d{2})(\d{2})/,'$1-$2-$3'),
        iban: iban || ""
      };

      function asPrettyText(p) {
        return `Payee: ${p.payee_full_name}
Bank: ${p.bank_name}
Account: ${p.account_number}
Sort code: ${p.sort_code}
IBAN: ${p.iban || 'â€”'}
Reference: ${ref}`;
      }

      const feedback = document.getElementById('feedback');

      async function copyAll() {
        const text = asPrettyText(payload);
        try {
          if (navigator.clipboard && navigator.clipboard.write) {
            const blob = new Blob([JSON.stringify({ ...payload, reference: ref }, null, 2)], { type: 'application/json' });
            await navigator.clipboard.write([
              new ClipboardItem({
                'text/plain': new Blob([text], { type: 'text/plain' }),
                'application/json': blob
              })
            ]);
          } else {
            await navigator.clipboard.writeText(text);
          }
          feedback.textContent = 'Copied. Now open your bank app.';
          feedback.className = 'ok';
        } catch (e) {
          feedback.textContent = 'Copy failed â€” long-press to copy.';
          feedback.className = 'err';
        }
      }

      async function copyField(key) {
        try {
          const map = {
            payee_full_name: payload.payee_full_name,
            bank_name: payload.bank_name,
            account_number: payload.account_number,
            sort_code: payload.sort_code,
            iban: payload.iban || ''
          };
          await navigator.clipboard.writeText(map[key] ?? '');
          feedback.textContent = 'Copied.';
          feedback.className = 'ok';
        } catch {
          feedback.textContent = 'Copy failed.';
          feedback.className = 'err';
        }
      }

      // Attach copy handlers
      document.getElementById('copyAll').addEventListener('click', copyAll);
      document.querySelectorAll('.copy-mini').forEach(b => b.addEventListener('click', () => copyField(b.dataset.k)));

      // --- Open bank app (modal chooser) ---
      const chooser     = document.getElementById('chooser');
      const chooserList = document.getElementById('chooserList');
      const banks = [
        { name:'Monzo',      scheme:'monzo://',                 androidStore:'https://play.google.com/store/apps/details?id=co.uk.getmondo', iosStore:'https://apps.apple.com/gb/app/monzo/id1058807477' },
        { name:'Starling',   scheme:'starling://',              androidStore:'https://play.google.com/store/apps/details?id=com.starlingbank.android', iosStore:'https://apps.apple.com/gb/app/starling-bank-mobile-banking/id1138470780' },
        { name:'Revolut',    scheme:'revolut://',               androidStore:'https://play.google.com/store/apps/details?id=com.revolut.revolut', iosStore:'https://apps.apple.com/gb/app/revolut/id932493382' },
        { name:'Barclays',   scheme:'barclaysmobilebanking://', androidStore:'https://play.google.com/store/apps/details?id=com.barclays.android.barclaysmobilebanking', iosStore:'https://apps.apple.com/gb/app/barclays/id433828350' },
        { name:'NatWest',    scheme:'natwest://',               androidStore:'https://play.google.com/store/apps/details?id=com.rbs.mobile.android.natwest', iosStore:'https://apps.apple.com/gb/app/natwest-mobile-banking/id310250715' },
        { name:'HSBC UK',    scheme:'hsbcukmobilebanking://',   androidStore:'https://play.google.com/store/apps/details?id=uk.co.hsbc.hsbcukmobilebanking', iosStore:'https://apps.apple.com/gb/app/hsbc-uk-mobile-banking/id1424253055' },
        { name:'Santander',  scheme:'santanderuk://',           androidStore:'https://play.google.com/store/apps/details?id=uk.co.santander.santanderUK', iosStore:'https://apps.apple.com/gb/app/santander-uk-mobile-banking/id435871685' },
        { name:'Lloyds',     scheme:'lloydsbank://',            androidStore:'https://play.google.com/store/apps/details?id=com.grppl.android.shell.CMBlloydsTSB73', iosStore:'https://apps.apple.com/gb/app/lloyds-bank-mobile-banking/id469960709' },
        { name:'Halifax',    scheme:'halifax://',               androidStore:'https://play.google.com/store/apps/details?id=com.grppl.android.shell.halifax', iosStore:'https://apps.apple.com/gb/app/halifax-mobile-banking/id310287928' },
        { name:'TSB',        scheme:'tsb://',                   androidStore:'https://play.google.com/store/apps/details?id=uk.co.tsb.mobilebank', iosStore:'https://apps.apple.com/gb/app/tsb-mobile-banking/id515307886' }
      ];

      function isAndroid() { return /Android/i.test(navigator.userAgent); }
      function openOrStore(scheme, label) {
        // Copy details for convenience every time
        navigator.clipboard.writeText(asPrettyText(payload)).catch(()=>{});
        try {
          // Use your existing helper if present
          if (typeof openAppOrStore === 'function') {
            openAppOrStore(scheme, label);
            return;
          }
        } catch {}
        // Generic attempt â†’ store
        const t = Date.now();
        location.href = scheme;
        setTimeout(() => {
          if (Date.now() - t < 1600) {
            const url = isAndroid()
              ? banks.find(b => b.scheme === scheme)?.androidStore
              : banks.find(b => b.scheme === scheme)?.iosStore;
            if (url) location.href = url;
          }
        }, 900);
      }

      function renderChooser() {
        chooserList.innerHTML = '';
        banks.forEach(b => {
          const a = document.createElement('a');
          a.className = 'app-btn';
          a.textContent = b.name;
          a.href = '#';
          a.addEventListener('click', (e) => {
            e.preventDefault();
            openOrStore(b.scheme, b.name);
          });
          chooserList.appendChild(a);
        });
      }
      renderChooser();

      document.getElementById('openChooser').addEventListener('click', () => {
        chooser.classList.add('open');
        copyAll(); // pre-copy so user can paste immediately
      });
      document.getElementById('chooserClose').addEventListener('click', () => chooser.classList.remove('open'));
      chooser.addEventListener('click', (e) => { if (e.target === chooser) chooser.classList.remove('open'); });
    })();
  </script>
</body>
</html>
